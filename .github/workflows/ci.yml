on: [push, pull_request]
name: CI

permissions:
    contents: read

jobs:
    build-windows:
        name: Build (Windows)
        runs-on: windows-latest
        env:
            BUILD_TIME:
        defaults:
            run:
                shell: msys2 {0}

        steps:
            - name: Install dependencies
              uses: msys2/setup-msys2@v2
              with:
                  install: >-
                      git
                      base-devel
                      mingw-w64-x86_64-gcc
                      mingw-w64-x86_64-cmake
                      mingw-w64-x86_64-curl
                      mingw-w64-x86_64-SDL2
                      mingw-w64-x86_64-SDL2_image
                      mingw-w64-x86_64-SDL2_mixer
                      mingw-w64-x86_64-SDL2_ttf
                  update: true

            - name: Checkout
              uses: actions/checkout@v4

            - name: Configure CMake
              run: cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

            - name: Build
              run: ninja -C build

            - name: Prepare artifact
              run: echo "BUILD_TIME=$(date '+%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: UnitedTiles-Windows_${{env.BUILD_TIME}}
                  path: ./

    build-ubuntu:
        name: Build (Ubuntu)
        runs-on: ubuntu-latest
        env:
            BUILD_TIME:

        steps:
            - name: Install dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y pkg-config ninja-build libcurl4-openssl-dev \
                    libsdl2-dev libsdl2-image-dev libsdl2-ttf-dev libsdl2-mixer-dev

            - name: Checkout
              uses: actions/checkout@v4

            - name: Configure CMake
              run: cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

            - name: Build
              run: ninja -C build

            - name: Prepare artifact
              run: echo "BUILD_TIME=$(date '+%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: UnitedTiles-Ubuntu_${{env.BUILD_TIME}}
                  path: ./

    android:
        name: Build (Android)
        runs-on: ubuntu-latest
        env:
            BUILD_TIME:

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Install Java
              uses: actions/setup-java@v4
              with:
                  distribution: zulu
                  java-version: 21

            - name: Setup Android SDK
              uses: android-actions/setup-android@v3

            - name: Build
              run: |
                  mkdir -p build
                  cp -R android/ build/
                  mkdir -p build/android/app/src/main/assets/
                  cp -R res/ build/android/app/src/main/assets/
                  cd build/android/
                  gradle assembleRelease --no-daemon

            - name: Prepare artifact
              run: echo "BUILD_TIME=$(date '+%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: UnitedTiles-Android_${{env.BUILD_TIME}}
                  path: ./
